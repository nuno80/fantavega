# Fantavega Project - Agent Guidelines

## Project Overview

Fantavega is a fantasy football (soccer) auction system built with Next.js 15, TypeScript, and real-time features.

## Current Development Status

- **Task 9 (UI Development)**: In Progress
  - âœ… Task 9.1: Layout and navigation components (COMPLETED)
  - âœ… Task 9.2: Auction interface components (COMPLETED)
  - âœ… Task 9.3: Player management interface (COMPLETED)
  - ðŸ”„ Task 9.4: Enhanced notifications (PENDING)

## Database Management

- Use `pnpm run db:reset` to reset database
- Use `pnpm run db:migrate` to apply schema changes
- Use `pnpm run db:seed` to populate with test data
- Database location: `database/starter_default.db`

## Key Architecture Patterns

1. **Server Components** for data fetching and authentication
2. **Client Components** for interactivity and real-time features
3. **Server Actions** for mutations and business logic
4. **Service Layer** in `src/lib/db/services/` for database operations
5. **Socket.IO** for real-time updates

## API Endpoints Structure

- `/api/user/*` - User-specific endpoints
- `/api/leagues/[league-id]/*` - League-specific endpoints
- `/api/admin/*` - Admin-only endpoints

## Authentication & Authorization

- Uses Clerk for authentication
- Role-based access: `admin` and `manager`
- User metadata stored in `user.publicMetadata.role`

## Real-time Features

- Socket.IO server runs on separate process
- WebSocket events for auction updates, bid notifications
- Client-side Socket context for real-time UI updates

## Component Organization

- `src/components/ui/` - Reusable UI components (shadcn/ui)
- `src/components/auction/` - Auction-specific components
- `src/components/players/` - Player management components
- `src/components/admin/` - Admin-only components

## Auto-Bid System Logic

### Core Components
1. **Auto-Bid Storage**: `auto_bids` table stores user preferences per auction
   - `auction_id`: Links to specific player auction
   - `user_id`: The bidder setting the auto-bid
   - `max_amount`: Maximum amount user is willing to bid
   - `is_active`: Boolean flag to enable/disable

2. **Auto-Bid Management API**: `/api/leagues/[league-id]/players/[player-id]/auto-bid`
   - POST: Set/update auto-bid with max amount (0 to disable)
   - GET: Retrieve current auto-bid settings
   - Validates budget availability and auction status

3. **Auto-Bid Activation Logic** (in `bid.service.ts`):
   - Triggered when someone places a bid <= current highest bid
   - Checks for active auto-bids with max_amount > current bid
   - Automatically places bid at (attempted_bid + 1) if auto-bid can cover it
   - Updates auction state and sends real-time notifications

### Auto-Bid Flow
1. User sets auto-bid via QuickBidModal or AutoBidModal components
2. When another user bids, system checks for competing auto-bids
3. If auto-bid exists and can cover the new bid amount + 1, it activates
4. Auto-bid places new bid automatically and updates locked credits
5. Real-time notifications sent to all league participants

## Penalty System Logic

### Core Components
1. **Compliance Tracking**: `user_league_compliance_status` table
   - Tracks compliance timer per user/league/phase
   - Records penalty application history
   - Manages grace periods and penalty cycles

2. **Compliance Check API**: `/api/leagues/[league-id]/check-compliance`
   - POST endpoint for users to trigger their own compliance check
   - Validates user participation in league
   - Calls `processUserComplianceAndPenalties` service

3. **Penalty Logic** (in `penalty.service.ts`):
   - Calculates required slots minus one for active auction roles
   - Counts covered slots (assigned players + winning bids)
   - Applies 1-hour grace period before penalties start
   - Deducts 5 credits per hour of non-compliance (max 5 penalties per cycle)
   - Resets penalty cycle when user becomes compliant

### Penalty Flow
1. System checks if user meets minimum roster requirements
2. If non-compliant, starts 1-hour grace period timer
3. After grace period, applies 5-credit penalties hourly
4. Penalties recorded in budget_transactions table
5. Real-time notifications sent to penalized user
6. Cycle resets when user becomes compliant

## Development Guidelines

- Always verify user authentication and roles
- Use TypeScript interfaces for data structures
- Implement proper error handling and loading states
- Follow responsive design patterns (mobile-first)
- Use real-time updates where appropriate

## Testing

- Test with both admin and manager roles
- Verify responsive design on different screen sizes
- Test real-time features with multiple browser tabs
- Validate API endpoints with proper authentication
- Test auto-bid activation with multiple competing bids
- Verify penalty system with non-compliant roster configurations