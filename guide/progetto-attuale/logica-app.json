{
  "projectName": "Fantavega - Fantacalcio Auction System",
  "last_task_completed": {
    "last_update": "2025-01-20T07:45:00Z",
    "task_completed": "Bug Fix - Sistema Rilanci con Auto-bid Sync",
    "feature_logic": {
      "feature_name": "Fix Sistema Rilanci con Auto-bid Sync e Error Recovery",
      "summary": "Risolve problema critico di sincronizzazione UI durante rilanci con auto-bid attivi. Quando auto-bid si attivano automaticamente, l'interfaccia utente non si aggiornava, causando errori 'offerta deve essere superiore' quando utenti tentavano rilanci con dati obsoleti.",
      "architectural_pattern": "Pattern di Error Recovery con Refresh Intelligente: rileva errori di sincronizzazione auto-bid, forza refresh immediato dei dati asta, e implementa gestione eventi socket migliorata per aggiornamenti real-time.",
      "user_flow": [
        "1. Team Red punta Butez a 10 crediti con auto-bid a 20 crediti.",
        "2. Team Fede rilancia a 11 crediti - auto-bid di Team Red si attiva automaticamente a 12 crediti.",
        "3. Team Fede imposta auto-bid a 25 e rilancia a 13 - sistema calcola offerta finale a 21 crediti (20+1).",
        "4. Team Fede tenta nuovo rilancio a 13 crediti ma UI mostra dati obsoleti.",
        "5. Sistema rileva errore 'superiore all'offerta attuale' e attiva error recovery.",
        "6. refreshCurrentAuctionData() forza aggiornamento immediato di asta, budget e manager.",
        "7. handleAuctionUpdate() gestisce eventi socket con toast notification per auto-bid.",
        "8. UI sincronizzata mostra 21 crediti come offerta attuale, prevenendo errori futuri."
      ],
      "core_components_interaction": {
        "src/app/auctions/AuctionPageContent.tsx": "Componente principale con error recovery per auto-bid sync. Gestisce handlePlaceBid() migliorato e handleAuctionUpdate() per eventi socket.",
        "handlePlaceBid()": "Funzione con detection errori auto-bid sync. Se rileva 'superiore all'offerta attuale', forza refreshCurrentAuctionData() e mostra messaggio specifico.",
        "refreshCurrentAuctionData()": "Helper function che aggiorna asta, budget e manager simultaneamente per sincronizzazione completa UI.",
        "handleAuctionUpdate()": "Nuovo listener socket per eventi auction-update con toast notification per auto-bid attivati e refresh immediato.",
        "src/components/auction/ManagerColumn.tsx": "Aggiornato per passare bidType correttamente a handlePlaceBid().",
        "src/app/api/leagues/[league-id]/players/[player-id]/bids/route.ts": "API con gestione errore specifico 'L'offerta deve essere superiore all'offerta attuale' come status 400 invece di 500.",
        "src/lib/db/services/bid.service.ts": "Servizio auto-bid con logica eBay che invia eventi auction-update con flag autoBidActivated per UI sync."
      },
      "database_interactions": [
        {
          "table": "auctions",
          "operation": "SELECT + UPDATE",
          "description": "Recupera e aggiorna dati asta corrente durante rilanci e auto-bid."
        },
        {
          "table": "auto_bids", 
          "operation": "SELECT",
          "description": "Controlla auto-bid attivi per logica eBay durante rilanci."
        },
        {
          "table": "bids",
          "operation": "INSERT + SELECT",
          "description": "Inserisce nuove offerte e recupera cronologia per UI sync."
        },
        {
          "table": "league_participants",
          "operation": "UPDATE",
          "description": "Aggiorna locked_credits durante cambio di miglior offerente."
        }
      ],
      "real_time_features": [
        {
          "event": "auction-update",
          "trigger": "Auto-bid activation o rilancio manuale",
          "data": "playerId, newPrice, highestBidderId, autoBidActivated flag",
          "ui_response": "Toast notification + refresh immediato dati asta"
        },
        {
          "event": "bid-surpassed-notification", 
          "trigger": "Utente superato da auto-bid",
          "data": "playerName, newBidAmount, autoBidActivated flag",
          "ui_response": "Notifica personalizzata + cambio stato rilancio_possibile"
        }
      ]
    },
    "bug_details": {
      "original_issue": "Team Fede rilancia Butez ma riceve errore 'L'offerta deve essere superiore all'offerta attuale' con oggetti di errore vuoti {}",
      "root_cause": "UI non si sincronizzava dopo attivazione auto-bid. Frontend mostrava 13 crediti mentre database aveva 21 crediti a causa di auto-bid eBay logic (20+1).",
      "error_manifestation": [
        "Console Error: Bid Error Details: {}",
        "Console Error: Bid Failure: {}",
        "Unhandled Runtime Error: An unexpected error occurred while processing your bid"
      ],
      "technical_cause": "handlePlaceBid() non gestiva errori di sync auto-bid e non forzava refresh UI dopo errori di offerta obsoleta."
    },
    "solution_implemented": [
      "Aggiunta detection specifica per errore 'superiore all'offerta attuale' in handlePlaceBid()",
      "Implementata refreshCurrentAuctionData() per sync completo asta/budget/manager",
      "Migliorato handleAuctionUpdate() con toast notification per auto-bid",
      "Aggiornato API error handling per status 400 invece di 500 su errori sync",
      "Garantita UI consistency dopo ogni tentativo di offerta (riuscito o fallito)"
    ],
    "files_modified": [
      "src/app/auctions/AuctionPageContent.tsx: Aggiunta error recovery e refresh logic",
      "src/components/auction/ManagerColumn.tsx: Fix bidType parameter passing", 
      "src/app/api/leagues/[league-id]/players/[player-id]/bids/route.ts: Improved error classification"
    ]
  }
}