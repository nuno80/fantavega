{
  "projectName": "Fantavega - Fantacalcio Auction System",
  "last_task_completed": {
    "last_update": "2024-07-02T12:00:00Z",
    "task_completed": "8.4 - Implement league status management controls",
    "feature_logic": {
      "feature_name": "Gestione Stato Lega (Admin)",
      "summary": "Implementa un controllo nella dashboard di gestione della lega che permette a un admin di cambiare la fase operativa della lega (es. da 'Iscrizioni Aperte' a 'Asta Iniziale').",
      "architectural_pattern": "Componente Client (`LeagueStatusManager`) che usa `useActionState` per invocare una Server Action (`updateLeagueStatusAction`). La logica di business è incapsulata in un servizio (`auction-league.service.ts`).",
      "user_flow": [
        "1. L'admin naviga alla dashboard della lega.",
        "2. Visualizza un pannello con lo stato attuale della lega e un dropdown con gli stati possibili.",
        "3. Seleziona un nuovo stato dal dropdown e clicca 'Aggiorna Stato'.",
        "4. La Server Action `updateLeagueStatusAction` viene chiamata.",
        "5. La action chiama il servizio `updateLeagueStatus` che esegue una query `UPDATE` sul database.",
        "6. La Server Action usa `revalidatePath` per aggiornare la UI della dashboard, mostrando il nuovo stato."
      ],
      "core_components_interaction": {
        "src/app/admin/leagues/[leagueId]/dashboard/page.tsx": "Pagina Server Component che passa lo stato attuale della lega al componente di gestione.",
        "src/components/admin/LeagueStatusManager.tsx": "Componente Client che renderizza il dropdown e il form per l'aggiornamento dello stato.",
        "src/lib/actions/league.actions.ts": "Contiene la `updateLeagueStatusAction` che orchestra la logica.",
        "src/lib/db/services/auction-league.service.ts": "Contiene la funzione `updateLeagueStatus` che esegue la modifica sul database."
      },
      "database_interactions": [
        {
          "table": "auction_leagues",
          "operation": "UPDATE",
          "description": "Aggiorna la colonna 'status' per la lega specificata."
        }
      ]
    }
  },
  "projectGoal": "Sviluppare una piattaforma d'asta per il fantacalcio con gestione di leghe/stagioni, aste per singoli giocatori con timer e reset, offerte manuali/quick, gestione budget per manager, e funzionalità di riparazione.",
  "currentDevelopmentPhase": "Task 8 (Controlli Amministrativi) completato. L'admin ha ora una suite completa per creare e gestire leghe e partecipanti. Prossimo task: 9 (Sviluppo UI).",
  "technologyStack": {
    "frontend": "Next.js 15.2.3 (App Router), React, TypeScript, Tailwind CSS",
    "backend": "Next.js API Routes & Server Actions (TypeScript)",
    "database": "BetterSQLite3 (accesso diretto)",
    "authentication": "Clerk",
    "realTime": "Socket.IO",
    "validation": "Zod",
    "packageManager": "pnpm",
    "developmentEnvironment": "Docker & Docker Compose (Node 20 Slim/Debian base)",
    "uiComponents": "shadcn/ui (base per theming), lucide-react (icone), sonner (notifiche)",
    "theming": "next-themes",
    "excelParsing": "xlsx (SheetJS)"
  },
  "databaseManagement": {
    "schemaDefinition": "SQL DDL in `database/schema.sql`",
    "dbConnection": "`src/lib/db/index.ts` (singleton pattern, crea DB file se non esiste)",
    "scripts": [
      { "name": "db:migrate", "purpose": "Applica l'intero `database/schema.sql`." },
      { "name": "db:reset", "purpose": "Effettua un backup, cancella il file del database e richiede una migrazione successiva per ricrearlo." },
      { "name": "db:apply-changes", "purpose": "Esegue query SQL ad-hoc da `database/adhoc_changes.sql` (con backup)." },
      { "name": "db:backup", "purpose": "Crea backup manuale." },
      { "name": "db:seed", "purpose": "Popola DB con dati di esempio." }
    ]
  },
  "coreEntitiesSchema": [
    { "tableName": "users", "description": "Estende utenti Clerk con `role` ('admin', 'manager') e `status`." },
    { "tableName": "players", "description": "Catalogo giocatori." },
    { "tableName": "auction_leagues", "description": "Configurazione della lega d'asta." },
    { "tableName": "league_participants", "description": "Associazione utenti a leghe. Traccia `current_budget`, `locked_credits`, etc." },
    { "tableName": "auctions", "description": "Asta per un singolo giocatore." },
    { "tableName": "bids", "description": "Log di ogni offerta." },
    { "tableName": "player_assignments", "description": "Traccia l'assegnazione finale di un giocatore a un manager." },
    { "tableName": "budget_transactions", "description": "Log delle modifiche al `current_budget`." },
    { "tableName": "user_league_compliance_status", "description": "Traccia lo stato di conformità dell'utente ai requisiti di rosa per lega/fase." }
  ],
  "leagueAndParticipantManagement": {
    "feature_name": "Gestione Leghe e Partecipanti (Admin)",
    "summary": "Fornisce all'admin una suite di strumenti per creare leghe, visualizzarle in una lista e gestire i partecipanti (aggiunta, modifica nome squadra, rimozione) e lo stato operativo di ogni lega dalla sua dashboard dedicata.",
    "architectural_pattern": "Pagine Server Components per il data fetching diretto e la visualizzazione. Le operazioni di modifica (mutations) sono gestite da componenti Client dedicati (forms, dialogs) che invocano Server Actions per interagire con il backend in modo sicuro.",
    "user_flow": [
      "1. **Creazione:** L'admin usa il form in `/admin/leagues/create` per creare una nuova lega.",
      "2. **Visualizzazione:** L'admin vede tutte le leghe create nella pagina `/admin/leagues`.",
      "3. **Gestione:** Cliccando su una lega, accede alla sua dashboard (`/admin/leagues/[id]/dashboard`).",
      "4. **Aggiunta Partecipante:** Dalla dashboard, l'admin può aggiungere nuovi manager.",
      "5. **Modifica Nome Squadra:** L'admin può modificare il nome di una squadra in qualsiasi momento tramite un popover.",
      "6. **Rimozione Partecipante:** L'admin può rimuovere un partecipante tramite un dialogo di conferma, ma solo se la lega è in stato 'participants_joining'.",
      "7. **Cambio Stato:** L'admin può cambiare la fase operativa della lega (es. da 'Iscrizioni Aperte' a 'Asta Attiva')."
    ]
  },
  "realTimeNotificationSystem": {
    "feature_name": "Sistema di Notifiche e Aggiornamenti in Tempo Reale",
    "summary": "Implementa un sistema basato su WebSocket (Socket.IO) per fornire aggiornamenti della UI in tempo reale e notifiche personali.",
    "architectural_pattern": "Pattern a 'Server Dedicato Stateful'. Un server Socket.IO (`socket-server.ts`) gira come processo separato. Il backend Next.js comunica con esso tramite un 'ponte HTTP'."
  },
  "auctionLogic": {
    "penaltySystem": {
      "trigger": "Al login/accesso sezioni chiave asta (approccio 'lazy').",
      "requirement": "Entro 1 ora dal trigger, N-1 slot coperti per ruoli attivi.",
      "penaltyApplication": "5 crediti se non conforme dopo 1 ora, con notifica real-time all'utente."
    }
  },
  "adminFunctionalitiesImplemented": [
    "Gestione Utenti (visualizzazione e cambio ruolo).",
    "Creazione di nuove leghe.",
    "Visualizzazione lista leghe.",
    "Dashboard di gestione lega con controlli per: aggiungere/rimuovere partecipanti, modificare nomi squadra e cambiare lo stato della lega."
  ],
  "managerFunctionalitiesImplemented_Backend": [
    "Offerte (iniziali, successive) con gestione `locked_credits`.",
    "Visualizzazione stato asta giocatore.",
    "Visualizzazione propria cronologia transazioni budget.",
    "Visualizzazione propria rosa.",
    "Trigger (implicito) del controllo di compliance per penalità.",
    "Ricezione aggiornamenti asta e notifiche (offerte superate, penalità) in tempo reale."
  ]
}
