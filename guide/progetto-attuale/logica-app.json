{
  "last_update": "2026-02-18T14:35:00Z",
  "task_completed": "FIX - Timer Rilanci Session Ghost",
  "feature_logic": {
    "feature_name": "Fix Timer Rilanci - Session Ghost Detection",
    "summary": "Risolve il bug dove il timer di risposta si attivava automaticamente per utenti offline a causa di sessioni fantasma (browser chiuso senza logout). Implementa un sistema di heartbeat per validare lo stato online e rimuove l'attivazione immediata del timer alla creazione.",
    "architectural_pattern": "Heartbeat-based session validation. Le API di polling aggiornano un timestamp (last_heartbeat) ad ogni richiesta. isUserCurrentlyOnline verifica che il heartbeat sia recente (< 2 min). I timer sono sempre creati come pendenti e attivati solo quando l'utente effettivamente visita la pagina.",
    "user_flow": [
      "1. Utente A apre la pagina asta → recordUserLogin crea sessione con last_heartbeat.",
      "2. Ogni fetch API (socket events) aggiorna last_heartbeat via updateHeartbeat.",
      "3. Utente B supera Utente A → createResponseTimer crea timer PENDENTE (mai attivato subito).",
      "4. Se Utente A è offline: timer resta pendente. isUserCurrentlyOnline ritorna false (heartbeat scaduto).",
      "5. Utente A ritorna → API chiama activateTimersForUser → timer si attiva con deadline 1 ora.",
      "6. Se Utente A non risponde entro 1 ora → scheduler processa timer → asta abbandonata."
    ],
    "core_components_interaction": {
      "src/lib/db/services/session.service.ts": "Aggiunta updateHeartbeat(). isUserCurrentlyOnline ora verifica last_heartbeat > (now - 120s).",
      "src/lib/db/services/response-timer.service.ts": "createResponseTimer non chiama più isUserCurrentlyOnline/activateTimerForUser. Timer sempre pendente.",
      "src/app/api/leagues/[league-id]/auction-state/route.ts": "Usa updateHeartbeat() invece di recordUserLogin().",
      "src/app/api/user/auction-states/route.ts": "Usa updateHeartbeat() invece di recordUserLogin().",
      "database/schema.sql": "Aggiunta colonna last_heartbeat a user_sessions."
    },
    "database_interactions": [
      {
        "table": "user_sessions",
        "operation": "ALTER TABLE (ADD COLUMN)",
        "description": "Aggiunta colonna last_heartbeat INTEGER per tracciare l'ultimo heartbeat."
      },
      {
        "table": "user_sessions",
        "operation": "UPDATE",
        "description": "updateHeartbeat aggiorna last_heartbeat ad ogni chiamata API di polling."
      }
    ]
  }
}
