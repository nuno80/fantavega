{
  "last_update": "2026-02-11T07:34:00Z",
  "task_completed": "BUGFIX - Compliance Timer + Data Corrections Leghe 8/9",
  "feature_logic": {
    "feature_name": "Fix Compliance Timer Lazy Evaluation + Script Diagnostico",
    "summary": "Corretto un bug critico in cui il timer di compliance si avviava per utenti offline. Creato script diagnostico per ispezionare lo stato completo di una lega su Turso. Applicate correzioni dati su leghe 8 e 9 (penalità, cooldown, timer, aste).",
    "architectural_pattern": "Parameterized Guard Pattern + Script diagnostico standalone con @libsql/client per accesso diretto a Turso.",
    "user_flow": [
      "1. Manager A è online, completa tutte le slot obbligatorie e fa logout.",
      "2. Manager B rilancia su un giocatore precedentemente vinto da A.",
      "3. Il server rileva la non-compliance di A ma NON avvia il timer (startTimerIfNonCompliant=false).",
      "4. Manager A torna online e accede alla pagina asta o fa login.",
      "5. Il frontend chiama /api/leagues/[id]/check-compliance con startTimerIfNonCompliant=true.",
      "6. ORA il timer di 1 ora parte, dando ad A il tempo di rimettersi in regola."
    ],
    "core_components_interaction": {
      "src/lib/db/services/penalty.service.ts": "checkAndRecordCompliance accetta startTimerIfNonCompliant (default true). Quando false, registra lo stato senza avviare countdown.",
      "src/lib/db/services/bid.service.ts": "Le 4 chiamate a checkAndRecordCompliance passano false per evitare timer per utenti offline.",
      "scripts/diagnose-league8.ts": "Script diagnostico per Turso. Uso: TURSO_DATABASE_URL=... TURSO_AUTH_TOKEN=... npx tsx scripts/diagnose-league8.ts. Mostra aste, offerte, timer, cooldown, compliance, sessioni, assegnazioni e transazioni per una lega."
    },
    "database_interactions": [
      {
        "table": "user_league_compliance_status",
        "operation": "UPDATE (condizionale)",
        "description": "compliance_timer_start_at impostato SOLO da trigger frontend."
      }
    ]
  }
}
